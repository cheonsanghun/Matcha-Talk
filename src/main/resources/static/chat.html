<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MatchTalk - 텍스트 채팅</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 1rem; background-color: #f8f9fa; }
        .container { max-width: 600px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #connection-form, #chat-form { margin-bottom: 1rem; display: flex; gap: 0.5rem; }
        #messages { height: 400px; overflow-y: scroll; border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .message-line { padding: 0.25rem 0; }
        .message-line strong { color: #007bff; }
        input[type="text"] { flex-grow: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 0.5rem 1rem; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let stompClient = null;
            let currentRoomId = null;

            const connectionForm = document.getElementById('connection-form');
            const chatContainer = document.getElementById('chat-container');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const messagesDiv = document.getElementById('messages');
            const chatRoomTitle = document.getElementById('chat-room-title');

            connectionForm.addEventListener('submit', function (event) {
                event.preventDefault();
                currentRoomId = document.getElementById('room-id').value;
                if (currentRoomId && !stompClient) {
                    connect();
                }
            });

            chatForm.addEventListener('submit', function(event) {
                event.preventDefault();
                sendMessage();
            });

            function connect() {
                const token = localStorage.getItem('jwt-token');
                if (!token) {
                    alert('로그인이 필요합니다. 먼저 로그인 페이지에서 로그인해주세요.');
                    return;
                }

                const socket = new SockJS('/ws-connect');
                stompClient = Stomp.over(socket);
                const headers = { 'Authorization': 'Bearer ' + token };

                stompClient.connect(headers, function(frame) {
                    console.log('Connected: ' + frame);
                    
                    document.getElementById('connection-container').style.display = 'none';
                    chatContainer.style.display = 'block';
                    chatRoomTitle.textContent = `채팅방 #${currentRoomId}`;

                    stompClient.subscribe('/topic/rooms/' + currentRoomId, function(message) {
                        onMessageReceived(JSON.parse(message.body));
                    });
                }, function(error) {
                    alert('연결에 실패했습니다.');
                    console.error('Connection error: ' + error);
                });
            }

            function sendMessage() {
                const messageContent = messageInput.value.trim();
                if (messageContent && stompClient) {
                    const chatMessage = {
                        roomId: currentRoomId,
                        content: messageContent
                    };
                    stompClient.send('/app/chat.sendMessage/' + currentRoomId, {}, JSON.stringify(chatMessage));
                    messageInput.value = '';
                }
            }

            function onMessageReceived(payload) {
                const p = document.createElement('p');
                p.style.margin = '0';
                p.innerHTML = `<strong>${payload.senderNickName}:</strong> ${payload.content}`;
                messagesDiv.appendChild(p);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>MatchTalk 채팅</h1>

        <div id="connection-container">
            <h2>채팅방 접속</h2>
            <form id="connection-form">
                <input type="text" id="room-id" placeholder="채팅방 ID를 입력하세요" required>
                <button type="submit">접속</button>
            </form>
        </div>

        <div id="chat-container" style="display: none;">
            <h2 id="chat-room-title"></h2>
            <div id="messages"></div>
            <form id="chat-form">
                <input type="text" id="message-input" placeholder="메시지를 입력하세요" autocomplete="off" required>
                <button type="submit">전송</button>
            </form>
        </div>
    </div>
</body>
</html>